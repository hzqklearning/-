<!DOCTYPE html>
<html>
    <head>
        <title>test</title>
        <meta charset="UTF-8"`>
    </head>
    <body>
        姓名:<input id="name">
        <button id="btn">(输入名字后请点击)连接</button>
        <br>
        文本发送：<input id="ipt"><button id="btn_send">发送</button>
        <div id="res_show">等待结果返回...</div>
    </body>
</html>

<script>
    var cnt = false
    var parter_id = new Set()
    var wsc
    var random_emo = ["&#128520;","&#128525;","&#128548;"]
    document.getElementById("btn").addEventListener("click",(evt)=>{
        if(cnt==false)
        {
            var name = document.getElementById("name").value
            if(name.trim().length==0)window.alert("请输入名字")
            else{
                wsc = new WebSocket("ws://47.96.5.21:3333")
                wsc.onopen = (evt)=>{
                    console.log("open:"+evt)
                    document.getElementById("res_show").innerHTML = "你已经连接到服务器啦 &#128512;"
                    cnt = true
                }
                wsc.onclose = (evt)=>{
                    console.log("close:"+evt)
                }
                wsc.onerror = (evt)=>{
                    console.log("error:"+ evt)
                }
                wsc.onmessage = (evt)=>{
                    var data = JSON.parse(evt.data)
                    if(data["type"]=="partner_id"){
                        parter_id.add(data["data"]["id"])
                        document.getElementById("res_show").innerHTML += ("<br>"+"叮叮叮，有人加入聊天室"+random_emo[Math.floor(Math.random()*3)])
                        console.log(parter_id)
                    }
                    else if(data["type"]=="message"){
                        var centence = data["data"]["centence"]
                        document.getElementById("res_show").innerHTML += ("<br>"+centence)
                    }
                    else if(data["type"]=="del_partner"){
                        parter_id.delete(data["data"]["id"])
                        document.getElementById("res_show").innerHTML += ("<br>"+"有人离开聊天室&#128557;")    
                        console.log(parter_id)
                    }
                }
            }
        }
    })
    document.getElementById("btn_send").addEventListener("click",(evt)=>{
        if(cnt==true){
            var str = document.getElementById("ipt").value
            var name = document.getElementById("name").value
            var new_line = name+": "+str
            document.getElementById("res_show").innerHTML += ("<br>"+new_line)
            for(let id_to of parter_id){
                wsc.send(JSON.stringify({id_to:id_to,data:{centence:new_line,name:name}}))
                // console.log(id_to)
            }
        }
    })
    document.getElementById("name").addEventListener("keydown",(evt)=>{
        if(evt.keyCode==13){
            document.getElementById("btn").click()
        }
    })
    document.getElementById("ipt").addEventListener("keydown",(evt)=>{
        if(evt.keyCode==13){
            document.getElementById("btn_send").click()
            document.getElementById("ipt").value = ""
        }
    })
</script>