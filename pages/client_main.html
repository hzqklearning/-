<!DOCTYPE html>
<html>
    <head>
        <title>Real-time communication with WebRTC</title>
        <meta charset="UTF-8"`>
        <style>
            body{
                font-family: Arial, Helvetica, sans-serif;
                margin: 0;
                padding: 20px;
                box-sizing: border-box;
                width: 100%;
            }
            .container{
                display: flex;
                flex-direction:row;
                gap:10px;
                width: 100%;
            }
            .left-container{
                width: 50vw;
            }
            .video-container{
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            video{
                width: 30vw;
                height: 25vw;
            }
            
            input,button{
                padding: 3px;
                margin: 3px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="left-container">
                æ˜µç§°(å¯æ›´æ”¹):<input id="name">
                <br>
                æ–‡æœ¬å‘é€ï¼š<input id="ipt">
                <button id="btn_send">å‘é€</button>
                <div id="res_show">å°è¯•è¿æ¥ä¸­...</div>
            </div>
            <div class="video-container">
                <button id="video_connection">è§†é¢‘è¿æ¥</button>
                <video id="local_video" autoplay playsinline></video>
                <video id="remote_video" autoplay playsinline></video>
            </div>
            
        </div>
    </body>
</html>

<script>
    let parter_id = new Set() //å¯¹æ–¹çš„idä¿¡æ¯ï¼ˆä¿¡ä»¤æœåŠ¡å™¨è½¬å‘æ—¶éœ€è¦ç”¨ï¼‰
    let wsc //web_socket_client 
    let random_emo = ["&#128520;","&#128525;","&#128548;"]
    let random_name = ["çŒ´å­ğŸ’","ç‹—å­ğŸ¶","å…”å­ğŸ‡","é¼ é¼ ğŸ­","å–·æ°´çš„é²¸ğŸ³","å–µğŸ±"]
    // let wss_addr = "wss://www.hzq2024.fun" //websocketçš„åœ°å€
    let wss_addr = "ws://localhost"
    document.getElementById("name").value = random_name[Math.floor(Math.random()*random_name.length)]+Math.random().toString(16).substr(2,2)
    //ä¸ä¿¡ä»¤æœåŠ¡å™¨å»ºç«‹è¿æ¥
    const max_time = 5
    let try_time = 0
    let cnt = false //æ˜¯å¦è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨
    function connectToServer(){
        if(cnt==false){
            try_time ++
            let name = document.getElementById("name").value
            wsc = new WebSocket(wss_addr)
            wsc.onopen = (evt)=>{
                document.getElementById("res_show").innerHTML += "<br>ä½ å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨å•¦ &#128512;"
                cnt = true
                try_time = 0
            }
            wsc.onclose = (evt)=>{
                const now = (window.performance.now() / 1000).toFixed(3)
                console.log(now,"close:"+evt.reason)
                cnt = false
                //é‡è¿æœºåˆ¶
                if(try_time<max_time){
                    if(try_time==0)document.getElementById("res_show").innerHTML += "<br>å°è¯•é‡è¿ä¸­......"
                    connectToServer()
                }
                else document.getElementById("res_show").innerHTML += "<br>è¿æ¥æœåŠ¡å™¨å¤±è´¥,è¯·åˆ·æ–°å°è¯• &#128561;"
            }
            wsc.onerror = (evt)=>{
                console.log("error:"+ evt.reason)
            }
            wsc.onmessage = async (evt)=>{
                let data = JSON.parse(evt.data)
                if(data["type"]=="partner_id"){
                    parter_id.add(data["data"]["id"])
                    document.getElementById("res_show").innerHTML += ("<br>"+"å®å®å®ï¼Œæœ‰äººåŠ å…¥èŠå¤©å®¤"+random_emo[Math.floor(Math.random()*3)])
                    // console.log(parter_id)
                }
                else if(data["type"]=="message"){
                    let m_type = data["data"]["type"]
                    if(m_type=="word"){
                        let centence = data["data"]["centence"]
                        document.getElementById("res_show").innerHTML += ("<br>"+centence)
                    }
                    else if(m_type=="answer"){
                        let sdp = data["data"]["sdp"]
                        await peer_connection.setRemoteDescription({
                            type:"answer",
                            sdp:sdp
                        })
                    }
                    else if(m_type=="call_ICE"){
                        let is_accept = confirm("å‘æ¥è§†é¢‘è¿æ¥,æ˜¯å¦è¦æ¥é€šå¹¶æ‰“å¼€æ‘„åƒå¤´")
                        if(is_accept){
                            await navigator.mediaDevices.getUserMedia(constraints)
                                .then(gotLocalMediaStream)
                                .catch(handleLocalMediaStreamError)
                            let sdp = data["data"]["sdp"]
                            await peer_connection.setRemoteDescription({
                                type:"offer",
                                sdp:sdp
                            })
                            peer_connection.createAnswer().then(async answer=>{
                                await peer_connection.setLocalDescription(answer)
                                for(let id_to of parter_id){
                                    wsc.send(JSON.stringify({id_to:id_to,data:{type:"answer",sdp:answer.sdp}}))
                                }
                            })
                        }
                    }
                    else if(m_type=="candidate_ICE"){
                        peer_connection.addIceCandidate(data["data"]["candidate"])
                        // console.log(data["data"]["candidate"])
                    }
                    
                }
                else if(data["type"]=="del_partner"){
                    parter_id.delete(data["data"]["id"])
                    document.getElementById("res_show").innerHTML += ("<br>"+"æœ‰äººç¦»å¼€èŠå¤©å®¤&#128557;")    
                    // console.log(parter_id)
                }
            }
            
        }
    }
    connectToServer()
    //è‡ªå®šä¹‰æ˜µç§°æ£€æµ‹
    document.getElementById("name").addEventListener("blur",(evt)=>{
        let name_ipt = document.getElementById("name")
        if(name_ipt.value.trim().length==0){
            let x = prompt("æ˜µç§°ä¸èƒ½ä¸ºç©º,è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ˜µç§°")
            while(x==null || x.trim().length==0){
                x = prompt("æ˜µç§°ä¸èƒ½ä¸ºç©º,è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ˜µç§°")
            }
            name_ipt.value = x

        }
    })
    //ç‚¹å‡»æŒ‰é’®è¿›è¡Œå‘é€
    document.getElementById("btn_send").addEventListener("click",(evt)=>{
        if(cnt==true){
            let str = document.getElementById("ipt").value
            let name = document.getElementById("name").value
            let new_line = name+": "+str
            document.getElementById("res_show").innerHTML += ("<br>"+new_line)
            for(let id_to of parter_id){
                wsc.send(JSON.stringify({id_to:id_to,data:{type:'word',centence:new_line,name:name}}))
            }
        }
    })
    //æŒ‰ä¸‹å›è½¦è§¦å‘å‘é€æŒ‰é’®
    document.getElementById("ipt").addEventListener("keydown",(evt)=>{
        if(evt.keyCode==13){
            document.getElementById("btn_send").click()
            document.getElementById("ipt").value = ""
        }
    })

    //è§†é¢‘æµåŠè§†é¢‘é€šè¯
    const constraints = {
        video:true,
        audio:true
    }
    const local_video = document.querySelector("#local_video")
    const remote_video = document.querySelector("#remote_video")
    let local_stream

    function gotLocalMediaStream(media_stream){
        local_stream = media_stream
        local_video.srcObject = media_stream
        media_stream.getTracks().forEach(track=>{
            peer_connection.addTrack(track,media_stream)
        })
    }

    function handleLocalMediaStreamError(error){
        console.log("navigator.getUserMedia error"+error)
    }

    //çŠ¶æ€ï¼šå‘èµ·è¿æ¥ç­‰å¾…å›åº”çŠ¶æ€ï¼Œç­‰å¾…offerçŠ¶æ€ï¼Œåå•†å®Œæ¯•çŠ¶æ€
    // const status = [
    //     "wait_answer",
    //     "wait_offer",
    //     "end"
    // ]
    // let init_state = "wait_offer"
    //ice
    const servers_config = {
        iceServers: [
            {
                urls: "stun:47.96.5.21:3478"
            },
            {
                urls: "turn:47.96.5.21:3478",
                username: "hzq",
                credential: "123456"
            }
        ]
    }
    let peer_connection = new RTCPeerConnection(servers_config);
    
    //ç‚¹å‡»è§†é¢‘è¿æ¥
    document.getElementById("video_connection").addEventListener("click",async (evt)=>{
        await navigator.mediaDevices.getUserMedia(constraints)
        .then(gotLocalMediaStream)
        .catch(handleLocalMediaStreamError)
        peer_connection.createOffer().then(async offer=>{
            await peer_connection.setLocalDescription(offer)
            for(let id_to of parter_id){
                wsc.send(JSON.stringify({id_to:id_to,data:{type:"call_ICE",sdp:offer.sdp}}))
            }
        })
    })
    peer_connection.addEventListener("icecandidate",(evt)=>{
        if(evt.candidate){
            for(let id_to of parter_id){
                wsc.send(JSON.stringify({id_to:id_to,data:{type:"candidate_ICE",candidate:evt.candidate}}))
                console.log(evt.candidate)
            }
        }
        
    })
    peer_connection.addEventListener("track",evt=>{
        remote_video.srcObject = evt.streams[0]
    })
    
    
</script>